# 
## PUT/DELETE API와 상태 코드
@PutMapping   
@DeleteMapping   
ResponseEntity 상태코드 보낼수 있음   
Talend API 테스트 가능   
   
PUT --> 리소스 전체 수정   
DELETE --> 리소스 삭제   
PATCH --> 일부 수정( 참고)   
   
* 사용자 수정 API(PUT)   
			
		@PutMapping("/{id}")
		public ResponseEntity<String> updateUser(
			@PathVariable Long id,
			@RequestBody UserDTO userDTO){
			
			return ResponseEntity.ok("Updated user: " + id);
		}
--> /users/{id}   

* 사용자 삭제 API(DELETE)   

		@DeleteMapping("/{id}")
		public ResponseEntity<Void> DeleteUser(@PathVariable Long id){
			return ResponseEntity.noContent().build();
		}

--> /users/{id}   
--> 삭제 후 본문 없이 상태 코드 204(No Content) 반환   
--> 204는 '삭제 완료 - 응답 내용' 의미   
   
* 상태 코드 정리   
200 OK --> 요청 성공 --> GET, PUT    
201 Created --> 리소스 생성 성공 --> POST   
204 Not Content --> 삭제 성공, 응답없음 --> DELETE   
400 Bad Request --> 잘못된 요청 --> 유효성 검사 실패    
403 Access Denied --> 접근 제한 --> 접근 권한이 없음.   
404 Not Found --> 자원 없음 --> 존재하지 않는 ID   
500 Internal Error --> 서버 오류 --> 예외 발생 시   
   
* Put 요청 Talend 테스트   
--> Talend에서 사용자 수정 API 테스트   
		URL : http://localhost:8080/users/1  
		 
		Method : PUT
		Body : {
			"name":"홍길동"
			"email" :"update@example.com"

		}

* 상태 코드 따라 응답 구성하기   
--> 조건에 따른 상태 코드 변경 실습   

		if(id == null || id <= 0){
			return REsponseEntity.badREquest().body("Invalid ID");
		}


* 과제   
ID 유효성 검사 로직 추가   
존재하지 않는 사용자에 대해서 404 응답 구성   

## DTO와 Validation 처리, 예외 처리 기본   
		public class UserDTo {   
			@NotNull (message = "이름은 필수입니다.");
			@Size(min = 2, message = "일므은 2차 이상이어야 합니다.")
			private String name;

			@Email(message = "이메일 형식이 아닙니다")
			private String email;

		}

## Valid 검증 활성화
--> 콘트롤러에서 @Valid 적용

		@PostMapping
		public ResponseEntity<String> createUser(@Valid @RequestBody UserDto userDTO){
			return REsponseEntity.ok("등록된 사용자:"+userDTO.getName());

		}

* Talend로 Validation 실패 테스트   
--> 잘못된 JSON으로 테스트 실습   
--> 예: name 이 한 글자, email이 비어 있음   

		{
			"name":""홍"
			"email":""
		}
--> 400 Bad Request

   
* 기본 예외 응답의 문제점   
--> 스프링 기본 오류 메시지의 한계      
   
메시지 포맷이 구조화되어 있지 않음      
메시지가 너무 길거나 직관적이지 않음      
클아이언트 UX에 좋지 않음      
   
* 예외 처리 구조   
--> @ControllerAdvice   


		throw 예외발생
		throws 호출한곳으로 되돌리는것

		@ControllerAdvice
		public class GlobalExceptionHandler{
			
			@ExceptionHandler  
			public ResonseEntity<String> handleValidationException(
				MethodArgumentNoValidException ex){
				return ResponseEntity.badRequest().body("검증 오류:"+ex.getMessage());

			}
		}

## 예제 : @Valid 유효성 처리

* ApiMemberController2

		@RestController
		public class ApiMemberController2 {

		    @Autowired
		    MemberRepository memberRepository;

		    //목록
		    @GetMapping("/api/members")
		    public ResponseEntity<List<MemberDto>> hello(){

			List<Member> members = memberRepository.findAll();

			List<MemberDto> memberDtos = members.stream()
				.map(member -> new MemberDto(member))
				.collect(Collectors.toList());

			return ResponseEntity.ok(memberDtos);
		    }

		    //등록
		    @PostMapping("/api/members")
		    public ResponseEntity<MemberDto> hello_get(@Valid @RequestBody MemberDto memberDto
		    ){
			System.out.println("1111");

			Member member = memberDto.toEntity();
			System.out.println("222");

			memberRepository.save(member);

			System.out.println("333");
			return ResponseEntity.ok(memberDto);
		    }

		    //수정
		    @PutMapping("/api/members/{id}")
		    public ResponseEntity<String> updateUser(@PathVariable Long id,
							     @RequestBody MemberDto memberDto){

			Member member = memberDto.toEntity();
			memberRepository.save(member);

			return ResponseEntity.ok("update user="+id);
		    }

		    //삭제
		    @DeleteMapping("/api/members/{id}")
		    public ResponseEntity<Void> updateDelete(@PathVariable Long id){
			memberRepository.deleteById(id);
			return ResponseEntity.noContent().build();

		    }


		}

* MemberDto

		@NoArgsConstructor
		@AllArgsConstructor
		@Setter
		@Getter
		public class MemberDto {
		    private Long id;

		    @NotNull(message = "이름입력은 필수입니다.")
		    @Size(min=2, max=20, message = "이름은 2자 이상 20자 미만입니다.")
		    private String name;

		    @NotNull(message = "전화번호는 필수입니다.")
		    @Size(min=3, max=20, message = "전화번호는 3자 이상 20자 미만입니다.")
		    private String phone;

		    @NotBlank(message = "이메일은 필수입니다.")
		    @Email(message = "유효한 이메일 주소를 입력하세요.")
		    private String email;

		    public MemberDto(Member member) {
			this.id = member.getId();
			this.name = member.getName();
			this.phone = member.getPhone();
		    }

		    public Member toEntity(){
			return new Member(name, phone, email);
		    }

		}

* Member

		@Entity
		@Getter
		@Setter
		public class Member {
		    @Id
		    @GeneratedValue(strategy = GenerationType.IDENTITY) // DB가 id 자동 생성
		    private Long id;

		    @Column(nullable = false)
		    private String name;

		    @Column(nullable = false)
		    private String phone;

		    @Column(nullable = false)
		    private String email;

		    public Member(){}
		    public Member(String name, String phone, String email) {
			//this.id = id;
			this.name = name;
			this.phone = phone;
			this.email = email;
		    }
		}

* RestControllerAdvice

		@RestControllerAdvice
		public class GlobalExceptionHandler {

		    @ExceptionHandler(MethodArgumentNotValidException.class)
		    public ResponseEntity<?> handleMethodArgumentNotValidException
			    (MethodArgumentNotValidException ex){

			HashMap<String, String> errors = new HashMap<>();
			for(FieldError fieldError : ex.getBindingResult().getFieldErrors()){
			    //System.out.println(fieldError.getField()+"___"+fieldError.getDefaultMessage());
			    errors.put(fieldError.getField(), fieldError.getDefaultMessage());
			}

			HashMap<String, Object> result = new HashMap<>();
			result.put("success", false);
			result.put("error",HttpStatus.BAD_REQUEST);
			result.put("data",errors);
		       // return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(result);

			return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(errors);
		    }
		}



## 실습형 과제 – PUT/DELETE API와 상태 코드

1. 사용자 수정 API에서 잘못된 ID 값(-1)이 들어오면 400 Bad Request가 반환되도록 조건문을 작성하시오.   

		if(id.equals(-1)){
				return ResponseEntity.badRequest().build();
		}

2. 사용자 삭제 API에서 존재하지 않는 ID가 들어오면 404 Not Found를 반환하도록 작성하시오.

		if(member == null){
				return ResponseEntity.notFound().build();
		}

3. DTO 유효성 검증을 위해 이름(name)은 2자 이상, 이메일은 이메일 형식이 되도록 `UserDTO`에 어노테이션을 추가하시오.

		@Size(min=2, message = "이름은 2차 이상이어야 합니다.")
		@NotBlank(message ="이메일은 필수입니다.")
		@Email(message="유효한 이메일이 아닙니다.")

4. `@Valid`를 사용하여 DTO의 유효성 검증을 활성화하려면 컨트롤러 메서드의 파라미터에 어떤 어노테이션을 추가해야 하는가?

		@Valid @ResponseBody MemberDto dto

5. Talend로 PUT 요청을 테스트할 때, 요청 본문에 포함해야 할 JSON 형식을 작성하시오.

		Application/json

6. 사용자 삭제 API 실행 후 성공적으로 삭제되었을 때, 어떤 HTTP 상태 코드를 반환하는가? 

		204 No Content

7. POST 요청 성공 시 일반적으로 사용하는 HTTP 상태 코드는?

		201 Created

8. 유효하지 않은 ID로 요청했을 때, 서버가 클라이언트에 보낼 수 있는 적절한 상태 코드는? 

		400 Bad Request

9. `@ControllerAdvice`를 사용한 예외 처리 클래스에서, DTO 유효성 실패 시 메시지를 사용자 친화적으로 바꾸려면 어떤 방식으로 처리하는가?

		new thorw 예외처리

10. DELETE 요청을 Talend API Tester에서 보낼 때, Body 설정은 어떻게 해야 하는가?

		ResponseEntity.noContent.build();



## ✅ 실습형 과제 10제


문제 1

사용자 수정 API에서 잘못된 ID 값(-1)이 들어오면 400 Bad Request가 반환되도록 조건문을 작성하시오.

	if (id == null || id <= 0) {
	    return ResponseEntity.badRequest().body("Invalid ID");
	}



문제 2

사용자 삭제 API에서 존재하지 않는 ID가 들어오면 404 Not Found를 반환하도록 작성하시오.

	if (!userService.existsById(id)) {
	    return ResponseEntity.status(HttpStatus.NOT_FOUND).build();
	}


문제 3

DTO 유효성 검증을 위해 이름(name)은 2자 이상, 이메일은 이메일 형식이 되도록 `UserDTO`에 어노테이션을 추가하시오.

	public class UserDTO {
	    @NotNull(message = "이름은 필수입니다.")
	    @Size(min = 2, message = "이름은 2자 이상이어야 합니다.")
	    private String name;

	    @Email(message = "이메일 형식이 아닙니다.")
	    private String email;
	}



문제 4

@Valid를 사용하여 DTO의 유효성 검증을 활성화하려면 컨트롤러에 어떤 어노테이션을 추가해야 하는가?

	public ResponseEntity<String> createUser(@Valid @RequestBody UserDTO userDTO) {
	    ...
	}


문제 5

Talend로 PUT 요청을 테스트할 때, 요청 본문에 포함해야 할 JSON 형식은?

	json
	{
	  "name": "홍길동",
	  "email": "update@example.com"
	}


문제 6   

사용자 삭제 API 실행 후 성공적으로 삭제되었을 때, 어떤 상태 코드를 반환하는가?   

	204 No Content


문제 7   
POST 요청 성공 시 일반적으로 사용하는 HTTP 상태 코드는?   

	201 Created


문제 8
유효하지 않은 ID로 요청했을 때 서버가 클라이언트에 보낼 수 있는 적절한 상태 코드는?

	400 Bad Request

문제 9
@ControllerAdvice를 사용한 예외 처리 클래스에서, 유효성 실패 시 메시지를 사용자 친화적으로 바꾸려면 어떤 방식으로 처리하는가?   

	@ExceptionHandler(MethodArgumentNotValidException.class)
	public ResponseEntity<String> handleValidationException(MethodArgumentNotValidException ex) {
	    return ResponseEntity.badRequest().body("검증 오류: " + ex.getMessage());
	}


문제 10
DELETE 요청을 Talend API Tester에서 보낼 때 Body는 어떻게 설정해야 하는가?

	Body: 없음 (비워둠)
