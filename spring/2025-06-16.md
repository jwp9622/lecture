# ğŸ“˜ DBì™€  ORM
   
## ë°ì´í„°ë² ì´ìŠ¤   
í´ë¼ì´ì–¸íŠ¸ í”„ë¦¬ì  í…Œì´ì…˜ ë¹„ì¦ˆë‹ˆìŠ¤ ì¸í‹°ê·¸ë ˆì´ì…˜ ë°ì´í„°ë¦¬ì†ŒìŠ¤   
-----------------------------------------------------
                                                      ë°ì´í„°ë² ì´ìŠ¤   
                                                     -------------   
   
                                       ORM(ì¸íŠ¹ë ˆì´ì…˜í‹°ì–´)   
                                       ----------------   

                 ---------------      
                 ë°±ì—”ë“œ ì„œë²„(MVC)   
   
 í”„ë¡ íŠ¸ì—”ë“œ   
-----------   
 ìš”ì²­(URL)       Controller Service       Entity         Mysql   
                            Repository   
## ORM   
   í´ë˜ìŠ¤   : í…Œì´ë¸”    = 1:1   
   ê°ì²´     : í–‰        = 1:1   
   ë©¤ë²„í•„ë“œ : ì»¬ëŸ¼      = 1:1     
   
## ìŠ¤í”„ë§ ë¶€íŠ¸   
JPA --> Entity   

## `@AllArgsConstructor` : ëª¨ë“  í•„ë“œ ë§¤ê°œë³€ìˆ˜ ìƒì„±ì   
## `@NoArgsConstructor` : íŒŒë¼ë¯¸í„° ì—†ëŠ” ê¸°ë³¸ ìƒì„±ì   
## `@Entity`  
ë°ì´í„°ë² ì´ìŠ¤ ë§¤í•‘   
Java Persistence API(JPA ì• ë…¸í…Œì´ì…˜)   
ì´ í´ë˜ìŠ¤ë¥¼ DB í…Œì´ë¸”ê³¼ ë§¤í•‘í•¨ì„ ì˜ë¯¸   
--> ì´ í´ë˜ìŠ¤ëŠ” ì—”í‹°í‹°ì´ë©°, DB í…Œì´ë¸”ì— í•´ë‹¹í•˜ëŠ” í´ë˜ìŠ¤   
   
    @Entity   
    public class User{   
        @Id // ëŒ€í‘œí‚¤ ì§€ì •   
        @GeneratedValue(strategy= GenerationType.IDENTITY) // DBê°€ ìë™ìœ¼ë¡œ 1ì”© ì¦ê°€   
        private Long id; // ëŒ€í‘œí‚¤   
    }   
   
## `@ToString`  
 rombokì—ì„œ ì œê³µí•˜ëŠ” ì• ë…¸í…Œì´ì…˜, return í•„ìš”   
 í´ë˜ìŠ¤ì˜ í•„ë“œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìë™ìœ¼ë¡œ toString()ë©”ì„œë“œë¥¼ ìƒì„±   
 ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ë©”ì†Œë“œ, ê°ì²´ìì‹ ì˜ ê°’ ë¦¬í„´ì„ ìœ„í•´ì„œ 

    if(obj1.equals(obj2)){   
   
    }else{   
   
    }
    String toString(){   
        return result;   
    }   
   
## JPA ì—ì„œ `@Entity`ê°€ ì˜ë¯¸ í•˜ëŠ” ê²ƒ   
    @Entity   
    @toString   
    public class User {   
        @Id   
        private Long id;   
        private String name;   
        private String email;   
    }   
**User í´ë˜ìŠ¤** ---> ë°ì´í„°ë² ì´ìŠ¤ì˜ userí…Œì´ë¸”ê³¼ ë§¤í•‘ëœë‹¤.   
**id, name, email** -->user í…Œì´ë¸”ì˜ ì¹¼ëŸ¼   
**@Id** --> ê¸°ë³¸ í‚¤(primary key) ì¹¼ëŸ¼   
**@ToString** --> ë””ë²„ê¹…í• ë•Œ User(id1,name=í™ê¸¸ë™, email=aa@bbb.com) í˜•íƒœë¡œ ìë™ ì¶œë ¥   
   
## ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ì„ ìœ„í•œ í•„ìš”í•œ êµ¬ì„±   
1. ì—”í‹°í‹° í´ë˜ìŠ¤(Entity)   
2. Repository ì¸í„°í˜ì´ìŠ¤(JPaReposity ìƒì†)   
3. ì„œë¹„ìŠ¤ í´ë˜ìŠ¤(ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬)   
4. DB ì„¤ì •(application.ymlë˜ëŠ” application.properties)   
   
## Repository ì˜ˆì‹œ   
    public interface UserRepository extends JpaRepository<User, Long>{   
        User findByEmailString email);   
    }   

## ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • ì˜ˆì‹œ(application.yml)      
    spring :      
      datasource :   
        userl: jdbc:mysql://localhost:3306/testdb      
        username:root      
        password:1234      
      jpa:      
        Hibernate:      
          ddl_auto:update   
        show-sql:true   
   
## ì „ì²´ ë™ì‘ íë¦„   
  Spring Boot ì‹¤í–‰ ì‹œ @Entity í´ë˜ìŠ¤ ê¸°ë°˜ìœ¼ë¡œ í…Œì´ë¸”ì„ ë§¤í•‘í•˜ê±°ë‚˜ ìƒì„±   
  UserRepositoryë¡œ ë°ì´í„°ë¥¼ ì¡°íšŒ/ì €ì¥   
  ì„œë¹„ìŠ¤ë‚˜ ì»¨íŠ¸ë¡¤ëŸ¬ ê³„ì¸µì—ì„œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìˆ˜í–‰   
   
## ì‹¤ë¬´ì—ì„œ ì£¼ì˜í•´ì•¼ í• ê²ƒ   
1. ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ vs ë‹¨ë°©í–¥    
ì–‘ë°©í–¥ ì„¤ì •í•  ë•Œ ë°˜ë“œì‹œ ""ë¬´í•œë£¨í”„"" ì£¼ì˜   
   
        @ToString   
        @Entity   
        public class Member {   
            @ManyToOne   
            private Team team;   
        }   

        @ToString   
        @Entity   
        public class Team{   
            @OneToMany(mapedBy = "team")   
            private List<Member> members;   
        }   

    ---> @ToString ì´ ì„œë¡œë¥¼ í˜¸ì¶œí•˜ë©´ì„œ StackOverflow ë°œìƒ ê°€ëŠ¥   
    ---> ""í•´ê²°ë°©ì•ˆ""   
       @ToString(exclude="otherEntity")   
       @JsonIgnore   
       @EQualsAndHashCode(exclude="...")   

2. ì—”í‹°í‹° ìƒì„± ì‹œ Setter ë‚¨ìš©ê¸ˆì§€   
ê°ì²´ê°€ ìƒì„±ëœ ë‹¤ìŒì— í•„ìš”ì— ì˜í•´ì„œ setter í˜¸ì¶œí•˜ë©´ ì „í›„ ê°„ê²© ì‹œê°„ì— ê°­ì´ ë°œìƒ   
ê·¸ ìƒíƒœì—ì„œ ì˜¤ë¥˜ ë°œìƒ ê°€ëŠ¥ì„± ë†’ìŒ.   
ì‹¤ë¬´ì—ì„œëŠ”  Setter ì‚¬ìš©ì„ ì§€ì–‘í•˜ê³ , ìƒì„±ì or Builder íŒ¨í„´ì„ ì‚¬ìš©í•˜ë¼   
    public class User{   
        private String name;   
        private String email;   
        protected User(){   
   
        }   
        public User(String name, String email){
            this.name = name;
            this.email = email;

        }
    }
   
3. ì§€ì—°ë¡œë”©(LAZY)ì£¼ì˜   
ì‹¤ë¬´ì—ì„  ê´€ê³„ í•„ë“œì— fetch = FetchType.LAZYë¥¼ ì“°ëŠ”ê²Œ ê¸°ë³¸   
ë‹¨, ì¡°íšŒì‹œ LazyInitilazationExceptionì´ ì•ˆ ë‚˜ë„ë¡ ì£¼ì˜í•´ì•¼í•¨.   
ë°ì´í„°ë¥¼ ì–¸ì œ ë¡œë”©í• ì§€ ê²°ì •í•˜ëŠ” ì˜µì…˜ì…ë‹ˆë‹¤.
LAZYëŠ” ì‹¤ì œ ë°ì´í„°ë¥¼ ì‚¬ìš©í•  ë•Œê¹Œì§€ ë¡œë”©ì„ ë¯¸ë£¨ëŠ” ì „ëµì…ë‹ˆë‹¤.

@ManytoOne(fetch=FetchType.LAZY)   
private Team team;   
    
        
    @Entity
    public class Member {

        @Id @GeneratedValue
        private Long id;

        private String name;

        @ManyToOne(fetch = FetchType.LAZY)
        private Team team;  // ì—°ê´€ëœ ì—”í‹°í‹°ëŠ” ë‚˜ì¤‘ì— ë¡œë”©ë¨
    }


    Member member = em.find(Member.class, 1L);  // ì—¬ê¸°ì„  teamì„ ë¡œë”©í•˜ì§€ ì•ŠìŒ
    System.out.println(member.getName());


    System.out.println(member.getTeam().getName());  // ì´ ì‹œì ì— team ì¿¼ë¦¬ ì‹¤í–‰ë¨!



| ì„¤ì •             | ë¡œë”© ì‹œì         | ì¥ì                  | ë‹¨ì              |
| -------------- | ------------ | ------------------ | -------------- |
| `LAZY` (ì§€ì—°ë¡œë”©)  | ì‹¤ì œ ì‚¬ìš©í•  ë•Œ     | ì„±ëŠ¥ ìµœì í™”, ë¶ˆí•„ìš”í•œ ì¿¼ë¦¬ ë°©ì§€ | N+1 ë¬¸ì œ ì£¼ì˜ í•„ìš”   |
| `EAGER` (ì¦‰ì‹œë¡œë”©) | ì—”í‹°í‹° ì¡°íšŒí•  ë•Œ ì¦‰ì‹œ | ì‚¬ìš© ê°„ë‹¨í•¨             | ë¶ˆí•„ìš”í•œ ë°ì´í„°ê¹Œì§€ ë¡œë”©ë¨ |



## ì—”í‹°í‹°(Entity) ì„¤ê³„ ì›ì¹™   
`@Entity` --> DB í…Œì´ë¸”ê³¼ ë§¤í•‘ë˜ëŠ” í´ë˜ìŠ¤   
`@Id` --> ê¸°ë³¸ í‚¤ ì§€ì •   
`@GeneratedValue` --> ìë™ ì¦ê°€ ì‹œí€€ìŠ¤ ì„¤ì •(1,2,3,4,....)   
`@Column` --> ì¹¼ëŸ¼ ì„¸ë¶€ ì„¤ì •(nullable(nullê°€ëŠ¥),unique(ìœ ì¼í•œê°’) ë“±)   
   
## ì—°ê´€ê´€ê³„ ë§¤í•‘   
**1:N --> @OneToMany**                 --> ì„±ëŠ¥ì£¼ì˜(N ì¿¼ë¦¬ ë°œìƒ)   
**N:1 --> @ManyToOne(fetch = LAZY)**   --> ê¸°ë³¸ ì„¤ì •ì€ LAZY   
**1:1 --> @OneToOne**                  --> ì™¸ë˜í‚¤ ì£¼ì˜(nullì´ê±°ë‚˜ pk)      
**N:N-->  @ManyToMany**               --> ì‹¤ë¬´ì—ì„œëŠ” ì‚¬ìš©ì•ˆí•¨(ì¤‘ê°„ í…Œì´ë¸” ì—”í‹°í‹°ë¡œ ë¶„ë¦¬)   
* ì‹¤ë¬´ì—ì„œëŠ” ë‹¨ë°©í–¥ ë§¤í•‘ì´ ì•ˆì „í•¨. ì–‘ë°©í–¥ì€ mappedBy/@JsonIgnore/@ToString(exclude ì‚¬ìš©)   

## ë°ì´í„°ë² ì´ìŠ¤ ì‹¤ë¬´ì  ì£¼ì˜ì‚¬í•­   
* **ì •ê·œí™”/ë¹„ì •ê·œí™”** --> 3 ì •ê·œí˜•ê¹Œì§€ê¹Œì§€ëŠ” ê¸°ë³¸, ì„±ëŠ¥ ê³ ë ¤ì‹œ ë¹„ì •ê·œí™”(ì¤‘ë³µ í—ˆìš©)ë„ ê³ ë ¤   
* **ëª…í™•í•œ ê¸°ë³¸ í‚¤**  --> surrogate key(id) natural key êµ¬ë¶„í•˜ê³  ID ì „ëµ ì§€ì •   
  - surrogate key :  ID (1, 2, 3) ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸
  - Natural Key : ì´ë©”ì¼ ì£¼ì†Œ ë“±
*  **ì œì•½ì¡°ê±´ ì •ì˜** --> Not null, Unique, Check, Defaultë“± ë°˜ë“œì‹œ ëª…ì‹œ   
* **ì¸ë±ìŠ¤ ì„¤ê³„** --> ìì£¼ ì¡°íšŒë˜ëŠ” ì¹¼ëŸ¼ì— ì ì ˆí•œ Index ìƒì„±(ê³¼ë„í•œ ì¸ë±ìŠ¤ëŠ” ì˜¤íˆë ¤ ì•ˆì¢‹ìŒ)   
* **í…Œì´ë¸”ì´ ë‹¨ìˆœ ì¡°íšŒì„±ì´ë©´** ì¸ë±ìŠ¤ ì„¤ì • ìœ ìš©, ìˆ˜ì •, ì‚­ì œ ë“±ë¡ì´ ë§ìœ¼ë©´ ì¸ë±ìŠ¤ë¥¼ ë§ì´ ì¡ìœ¼ë©´ ì•ˆë¨.   
   - ì‚¬ì „ --> ë‹¨ì–´ê°€ ë§¤ë²ˆ ì¶”ê°€ë˜ë©´ ê³ ë¶€í•˜ ë  ìˆ˜ ìˆìŒ   
* **Enumì€ ë³„ë„ í…Œì´ë¸” or Varchar** -> DBì—  Enumì„ ì§ì ‘ ì“°ë©´ ì´ì‹ì„± ë–¨ì–´ì§   
   
## ì„±ëŠ¥ ê´€ë ¨ ì£¼ì˜ì‚¬í•­   
**ì¸ë±ìŠ¤ ì˜¤ìš© ë°©ì§€** --> ì¡°ê±´ì ˆì— í•¨ìˆ˜ ì‚¬ìš©ì‹œ ì¸ë±ìŠ¤ ë¯¸ì‚¬ìš©( Where Date(Created_at))   
**N + 1ë¬¸ì œ** --> ORM ì‚¬ìš©ì‹œ JOIN ì•ˆ ì“°ë©´ ì—°ê´€ ì—”í‹°í‹° ìˆ˜ë§Œí¼ ì¿¼ë¦¬ ë°œìƒ   
**Batch ì²˜ë¦¬** --> ëŒ€ìš©ëŸ‰ insert/update ì‹œ ë°˜ë“œì‹œ Batch ì²˜ë¦¬ ê³ ë ¤   
**ì¿¼ë¦¬ íŠœë‹** --> Explain, ì‹¤í–‰ê³„íš í™œìš©í•´ì„œ ì¸ë±ìŠ¤ ì—¬ë¶€, full scan ì—¬ë¶€ ì²´í¬   
   
## ë°ì´í„° ì •í•©ì„±ê³¼ ë¬´ê²°ì„±   
íŠ¸ëœì­ì…˜ ì²˜ë¦¬ -> ë…¼ë¦¬ ë‹¨ìœ„ë¡œ commit/rollback ì •í™•í•˜ê²Œ ë¬¶ê¸°   
ì‘ì—…ì´ ì—¬ëŸ¬ê°œì¼ê²½ìš°ì—ëŠ” ë¬¶ì–´ì„œ í•œêº¼ë²ˆì— commit í•´ì•¼í•¨.   
ê±°ë˜1 \   
ê±°ë˜2  í•œë²ˆì—commit í•´ì•¼í•¨.   
ê±°ë˜3 /   
   
ì™¸ë˜í‚¤(FK) --> ê°€ëŠ¥í•œ ì„¤ì •, ë‹¨ ë³µì¡í•œ ì‹œìŠ¤í…œì—ì„  ""ë…¼ë¦¬ì  ê´€ë¦¬""ë„ ê³ ë ¤   
 ì˜ˆ) í™ê¸¸ë„ ì§ì› ì…ì‚¬ì¼, ìƒì‚¬, ì›”ê¸‰, ë¶€ì„œ   
 Cascade ì£¼ì˜ --> ON DELETE CASCADE ë‚¨ìš©ì‹œ ì‹¤ìˆ˜ë¡œ ë‹¤ ì‚­ì œë  ìˆ˜ ìˆìŒ.   
 ë™ì‹œì„± ì œì–´ --> Optimistic Locking(@Version) or Perssimistic Locking ê³ ë ¤   
